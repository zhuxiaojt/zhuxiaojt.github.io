name: å›¾åºŠä¸Šä¼ API

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - single    # å•æ–‡ä»¶ä¸Šä¼ 
          - start     # å¼€å§‹åˆ†å—ä¸Šä¼ 
          - chunk     # ä¸Šä¼ åˆ†å—
          - complete  # å®Œæˆä¸Šä¼ 
          - cleanup   # æ¸…ç†è¿‡æœŸæ–‡ä»¶
      fileId:
        description: 'æ–‡ä»¶ID'
        required: false
        default: ''
        type: string
      chunkIndex:
        description: 'åˆ†å—åºå·'
        required: false
        default: ''
        type: string
      totalChunks:
        description: 'æ€»åˆ†å—æ•°'
        required: false
        default: ''
        type: string
      fileExtension:
        description: 'æ–‡ä»¶æ‰©å±•å'
        required: false
        default: ''
        type: string
      chunkData:
        description: 'åˆ†å—æ•°æ®Base64'
        required: false
        default: ''
        type: string
      fileName:
        description: 'æ–‡ä»¶å'
        required: false
        default: ''
        type: string
      base64Content:
        description: 'å®Œæ•´æ–‡ä»¶Base64'
        required: false
        default: ''
        type: string

jobs:
  file-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # æ•´ä¸ªjobæœ€å¤šè¿è¡Œ1å°æ—¶
    permissions:
      contents: write
    env:
      UPLOAD_DIR: "img"
      TEMP_DIR: "temp_uploads"
      COUNTER_FILE: "api/img/cnt.txt"
      REPO: ${{ github.repository }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    steps:
      - name: åˆå§‹åŒ–ç¯å¢ƒ
        id: init
        run: |
          echo "OPERATION=${{ github.event.inputs.operation }}" >> $GITHUB_ENV
          echo "FILE_ID=${{ github.event.inputs.fileId }}" >> $GITHUB_ENV
          echo "CHUNK_INDEX=${{ github.event.inputs.chunkIndex }}" >> $GITHUB_ENV
          echo "TOTAL_CHUNKS=${{ github.event.inputs.totalChunks }}" >> $GITHUB_ENV
          echo "FILE_EXT=${{ github.event.inputs.fileExtension }}" >> $GITHUB_ENV
          echo "CHUNK_DATA=${{ github.event.inputs.chunkData }}" >> $GITHUB_ENV
          echo "FILE_NAME=${{ github.event.inputs.fileName }}" >> $GITHUB_ENV
          echo "BASE64_CONTENT=${{ github.event.inputs.base64Content }}" >> $GITHUB_ENV
          echo "START_TIME=$(date +%s)" >> $GITHUB_ENV
          
      # ==================== å•æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ ====================
      - name: å¤„ç†å•æ–‡ä»¶ä¸Šä¼ 
        if: env.OPERATION == 'single' && env.BASE64_CONTENT != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== å•æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ ==="
          
          # è¯»å–è®¡æ•°å™¨æ–‡ä»¶
          COUNTER_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}")
          
          FILE_CONTENT=$(echo "$COUNTER_RESPONSE" | jq -r '.content // empty')
          if [ -z "$FILE_CONTENT" ]; then
            echo "âŒ é”™è¯¯ï¼šè®¡æ•°å™¨æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi
          
          FILE_NUM=$(echo "$FILE_CONTENT" | base64 -d)
          if ! [[ $FILE_NUM =~ ^[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šè®¡æ•°å™¨æ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆæ•°å­—: '$FILE_NUM'"
            exit 1
          fi
          
          NEW_NUM=$((FILE_NUM + 1))
          
          # ç”Ÿæˆæ–‡ä»¶å
          ORIGIN_NAME="${{ env.FILE_NAME }}"
          if [[ "$ORIGIN_NAME" == *.* ]]; then
            FILE_EXT=".${ORIGIN_NAME##*.}"
          else
            FILE_EXT=""
          fi
          
          FINAL_FILENAME="$NEW_NUM$FILE_EXT"
          UPLOAD_PATH="${{ env.UPLOAD_DIR }}/$FINAL_FILENAME"
          
          echo "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: $FINAL_FILENAME"
          
          # ä¸Šä¼ æ–‡ä»¶
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"ä¸Šä¼ æ–‡ä»¶: $FINAL_FILENAME\",\"content\":\"${{ env.BASE64_CONTENT }}\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$UPLOAD_PATH"
          
          # æ›´æ–°è®¡æ•°å™¨
          COUNTER_SHA=$(echo "$COUNTER_RESPONSE" | jq -r '.sha')
          NEW_NUM_BASE64=$(echo -n "$NEW_NUM" | base64)
          
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"æ›´æ–°è®¡æ•°å™¨: $NEW_NUM\",\"content\":\"$NEW_NUM_BASE64\",\"sha\":\"$COUNTER_SHA\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}"
          
          echo "âœ… ä¸Šä¼ æˆåŠŸï¼"
          echo "ğŸ“ æ–‡ä»¶å: $FINAL_FILENAME"
          echo "ğŸ“ è·¯å¾„: $UPLOAD_PATH"
          echo "ğŸ”— Raw URL: https://raw.githubusercontent.com/${{ env.REPO }}/main/$UPLOAD_PATH"
          echo "ğŸŒ CDN URL: https://cdn.jsdelivr.net/gh/${{ env.REPO }}/$UPLOAD_PATH"
          
      # ==================== å¼€å§‹åˆ†å—ä¸Šä¼  ====================
      - name: å¼€å§‹åˆ†å—ä¸Šä¼ 
        if: env.OPERATION == 'start'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== å¼€å§‹åˆ†å—ä¸Šä¼  ==="
          
          # éªŒè¯è¾“å…¥
          if [ -z "${{ env.TOTAL_CHUNKS }}" ] || [ -z "${{ env.FILE_EXT }}" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å‚æ•° (totalChunks, fileExtension)"
            exit 1
          fi
          
          # è¯»å–è®¡æ•°å™¨æ–‡ä»¶
          COUNTER_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}")
          
          FILE_CONTENT=$(echo "$COUNTER_RESPONSE" | jq -r '.content // empty')
          if [ -z "$FILE_CONTENT" ]; then
            echo "âŒ é”™è¯¯ï¼šè®¡æ•°å™¨æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi
          
          FILE_NUM=$(echo "$FILE_CONTENT" | base64 -d)
          if ! [[ $FILE_NUM =~ ^[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯ï¼šè®¡æ•°å™¨æ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆæ•°å­—: '$FILE_NUM'"
            exit 1
          fi
          
          NEW_NUM=$((FILE_NUM + 1))
          
          # åˆ›å»ºçŠ¶æ€æ–‡ä»¶
          TOTAL_CHUNKS=${{ env.TOTAL_CHUNKS }}
          FILE_EXT="${{ env.FILE_EXT }}"
          
          # åˆå§‹åŒ–æ‰€æœ‰åˆ†å—çŠ¶æ€ä¸º pending
          CHUNKS_JSON="{"
          for i in $(seq 0 $((TOTAL_CHUNKS - 1))); do
            if [ $i -gt 0 ]; then
              CHUNKS_JSON="$CHUNKS_JSON,"
            fi
            CHUNKS_JSON="$CHUNKS_JSON\"$i\":\"pending\""
          done
          CHUNKS_JSON="$CHUNKS_JSON}"
          
          STATUS_JSON=$(jq -n \
            --arg fileId "$NEW_NUM" \
            --arg extension "$FILE_EXT" \
            --arg totalChunks "$TOTAL_CHUNKS" \
            --arg startTime "$(date +%s)" \
            --argjson chunks "$CHUNKS_JSON" \
            '{
              fileId: $fileId,
              extension: $extension,
              totalChunks: $totalChunks | tonumber,
              startTime: $startTime | tonumber,
              chunks: $chunks
            }')
          
          STATUS_BASE64=$(echo -n "$STATUS_JSON" | base64 -w 0)
          
          # åˆ›å»ºçŠ¶æ€æ–‡ä»¶
          STATUS_FILE="${{ env.TEMP_DIR }}/TEMPMETA_${NEW_NUM}.json"
          echo "åˆ›å»ºçŠ¶æ€æ–‡ä»¶: $STATUS_FILE"
          
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"å¼€å§‹åˆ†å—ä¸Šä¼ : $NEW_NUM\",\"content\":\"$STATUS_BASE64\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE"
          
          # ç«‹å³æ›´æ–°è®¡æ•°å™¨ï¼ˆé¿å…å†²çªï¼‰
          COUNTER_SHA=$(echo "$COUNTER_RESPONSE" | jq -r '.sha')
          NEW_NUM_BASE64=$(echo -n "$NEW_NUM" | base64 -w 0)
          
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"é¢„åˆ†é…æ–‡ä»¶ç¼–å·: $NEW_NUM\",\"content\":\"$NEW_NUM_BASE64\",\"sha\":\"$COUNTER_SHA\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}"
          
          echo "âœ… å¼€å§‹ä¸Šä¼ æˆåŠŸï¼"
          echo "ğŸ“„ æ–‡ä»¶ID: $NEW_NUM"
          echo "ğŸ“ æ‰©å±•å: $FILE_EXT"
          echo "ğŸ”¢ æ€»åˆ†å—æ•°: $TOTAL_CHUNKS"
          echo "ğŸ“‹ çŠ¶æ€æ–‡ä»¶: $STATUS_FILE"
          
      # ==================== ä¸Šä¼ åˆ†å— ====================
      - name: ä¸Šä¼ åˆ†å—
        if: env.OPERATION == 'chunk'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== ä¸Šä¼ åˆ†å— ==="
          
          # éªŒè¯è¾“å…¥
          if [ -z "${{ env.FILE_ID }}" ] || [ -z "${{ env.CHUNK_INDEX }}" ] || [ -z "${{ env.CHUNK_DATA }}" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å‚æ•° (fileId, chunkIndex, chunkData)"
            exit 1
          fi
          
          FILE_ID="${{ env.FILE_ID }}"
          CHUNK_INDEX="${{ env.CHUNK_INDEX }}"
          CHUNK_DATA="${{ env.CHUNK_DATA }}"
          START_TIME="${{ env.START_TIME }}"
          MAX_WAIT=3600  # 1å°æ—¶
          
          # å¾ªç¯ç­‰å¾…ç›´åˆ°å¯ä»¥ä¸Šä¼ 
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            # è¶…æ—¶æ£€æŸ¥
            if [ $ELAPSED -gt $MAX_WAIT ]; then
              echo "âŒ ç­‰å¾…è¶…æ—¶ï¼ˆ1å°æ—¶ï¼‰ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶å¹¶é€€å‡º"
              
              # æ¸…ç†è‡ªå·±çš„ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              TEMP_CHUNK_FILE="${{ env.TEMP_DIR }}/TEMPCHUNK_${FILE_ID}_${CHUNK_INDEX}.dat"
              CHUNK_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${{ env.REPO }}/contents/$TEMP_CHUNK_FILE")
              
              if ! echo "$CHUNK_RESPONSE" | grep -q '"message":"Not Found"'; then
                CHUNK_SHA=$(echo "$CHUNK_RESPONSE" | jq -r '.sha // empty')
                if [ -n "$CHUNK_SHA" ] && [ "$CHUNK_SHA" != "null" ]; then
                  curl -X DELETE -s \
                    -H "Authorization: token $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    -d "{\"message\":\"æ¸…ç†è¶…æ—¶åˆ†å—\",\"sha\":\"$CHUNK_SHA\",\"branch\":\"main\"}" \
                    "https://api.github.com/repos/${{ env.REPO }}/contents/$TEMP_CHUNK_FILE"
                  echo "å·²æ¸…ç†åˆ†å— $CHUNK_INDEX çš„ä¸´æ—¶æ–‡ä»¶"
                fi
              fi
              
              exit 1
            fi
            
            # æ£€æŸ¥çŠ¶æ€æ–‡ä»¶
            STATUS_FILE="${{ env.TEMP_DIR }}/TEMPMETA_${FILE_ID}.json"
            STATUS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE")
            
            # å¦‚æœçŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯´æ˜ä¸Šä¼ å·²å–æ¶ˆæˆ–å·²å®Œæˆ
            if echo "$STATUS_RESPONSE" | grep -q '"message":"Not Found"'; then
              echo "â³ çŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç­‰å¾…5ç§’..."
              sleep 5
              continue
            fi
            
            STATUS_CONTENT=$(echo "$STATUS_RESPONSE" | jq -r '.content // empty' | base64 -d)
            if [ -z "$STATUS_CONTENT" ]; then
              echo "â³ çŠ¶æ€æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œç­‰å¾…5ç§’..."
              sleep 5
              continue
            fi
            
            # æ£€æŸ¥å½“å‰åˆ†å—çŠ¶æ€
            CURRENT_STATUS=$(echo "$STATUS_CONTENT" | jq -r ".chunks[\"$CHUNK_INDEX\"] // \"pending\"")
            
            if [ "$CURRENT_STATUS" = "completed" ]; then
              echo "âœ… åˆ†å— $CHUNK_INDEX å·²ç»å®Œæˆä¸Šä¼ "
              break
            elif [ "$CURRENT_STATUS" = "uploading" ]; then
              echo "â³ åˆ†å— $CHUNK_INDEX æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œç­‰å¾…10ç§’..."
              sleep 10
              continue
            fi
            
            # æ£€æŸ¥ä¸Šä¸€ä¸ªåˆ†å—
            if [ $CHUNK_INDEX -eq 0 ]; then
              # ç¬¬0å—ï¼šåªè¦ä¸æ˜¯ uploading å°±å¯ä»¥å¼€å§‹
              if [ "$CURRENT_STATUS" = "pending" ]; then
                echo "âœ… å¯ä»¥ä¸Šä¼ åˆ†å— 0ï¼ˆç¬¬ä¸€ä¸ªåˆ†å—ï¼‰"
                break
              else
                echo "â³ åˆ†å— 0 çŠ¶æ€ä¸º $CURRENT_STATUSï¼Œç­‰å¾…5ç§’..."
                sleep 5
              fi
            else
              # å…¶ä»–å—ï¼šæ£€æŸ¥ä¸Šä¸€ä¸ªåˆ†å—æ˜¯å¦å®Œæˆ
              PREV_INDEX=$((CHUNK_INDEX - 1))
              PREV_STATUS=$(echo "$STATUS_CONTENT" | jq -r ".chunks[\"$PREV_INDEX\"] // \"pending\"")
              
              if [ "$PREV_STATUS" = "completed" ]; then
                echo "âœ… ä¸Šä¸€ä¸ªåˆ†å— $PREV_INDEX å·²å®Œæˆï¼Œå¯ä»¥ä¸Šä¼ åˆ†å— $CHUNK_INDEX"
                break
              else
                echo "â³ ç­‰å¾…ä¸Šä¸€ä¸ªåˆ†å— $PREV_INDEX å®Œæˆï¼ˆå½“å‰çŠ¶æ€: $PREV_STATUSï¼‰ï¼Œå·²ç­‰å¾… ${ELAPSED}ç§’"
                sleep 10
              fi
            fi
          done
          
          # æ ‡è®°ä¸ºæ­£åœ¨ä¸Šä¼ 
          echo "æ ‡è®°åˆ†å— $CHUNK_INDEX ä¸º uploading..."
          STATUS_SHA=$(echo "$STATUS_RESPONSE" | jq -r '.sha // empty')
          
          # æ›´æ–°çŠ¶æ€ä¸º uploading
          UPDATED_STATUS=$(echo "$STATUS_CONTENT" | jq ".chunks[\"$CHUNK_INDEX\"] = \"uploading\"")
          UPDATED_BASE64=$(echo -n "$UPDATED_STATUS" | base64 -w 0)
          
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"å¼€å§‹ä¸Šä¼ åˆ†å— $CHUNK_INDEX\",\"content\":\"$UPDATED_BASE64\",\"sha\":\"$STATUS_SHA\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE"
          
          # ä¸Šä¼ åˆ†å—æ•°æ®
          echo "ä¸Šä¼ åˆ†å— $CHUNK_INDEX çš„æ•°æ®..."
          TEMP_CHUNK_FILE="${{ env.TEMP_DIR }}/TEMPCHUNK_${FILE_ID}_${CHUNK_INDEX}.dat"
          
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"åˆ†å— $CHUNK_INDEX\",\"content\":\"$CHUNK_DATA\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$TEMP_CHUNK_FILE"
          
          # æ ‡è®°ä¸ºå·²å®Œæˆ
          echo "æ ‡è®°åˆ†å— $CHUNK_INDEX ä¸º completed..."
          
          # é‡æ–°è¯»å–çŠ¶æ€æ–‡ä»¶ï¼ˆSHAå¯èƒ½å·²å˜ï¼‰
          STATUS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE")
          
          STATUS_CONTENT=$(echo "$STATUS_RESPONSE" | jq -r '.content // empty' | base64 -d)
          STATUS_SHA=$(echo "$STATUS_RESPONSE" | jq -r '.sha // empty')
          
          UPDATED_STATUS=$(echo "$STATUS_CONTENT" | jq ".chunks[\"$CHUNK_INDEX\"] = \"completed\"")
          UPDATED_BASE64=$(echo -n "$UPDATED_STATUS" | base64 -w 0)
          
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"message\":\"å®Œæˆåˆ†å— $CHUNK_INDEX\",\"content\":\"$UPDATED_BASE64\",\"sha\":\"$STATUS_SHA\",\"branch\":\"main\"}" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE"
          
          echo "âœ… åˆ†å— $CHUNK_INDEX ä¸Šä¼ å®Œæˆ"
          
      # ==================== å®Œæˆä¸Šä¼  ====================
      - name: å®Œæˆåˆ†å—ä¸Šä¼ 
        if: env.OPERATION == 'complete'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== å®Œæˆåˆ†å—ä¸Šä¼  ==="
          
          if [ -z "${{ env.FILE_ID }}" ]; then
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å‚æ•° (fileId)"
            exit 1
          fi
          
          FILE_ID="${{ env.FILE_ID }}"
          START_TIME=$(date +%s)
          MAX_WAIT=1800  # 30åˆ†é’Ÿï¼Œç­‰å¾…æ‰€æœ‰åˆ†å—å®Œæˆ
          
          # 1. é¦–å…ˆæ£€æŸ¥çŠ¶æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          STATUS_FILE="${{ env.TEMP_DIR }}/TEMPMETA_${FILE_ID}.json"
          
          # ç­‰å¾…çŠ¶æ€æ–‡ä»¶å‡ºç°ï¼ˆå¯èƒ½è¿˜åœ¨åˆ›å»ºä¸­ï¼‰
          echo "ç­‰å¾…çŠ¶æ€æ–‡ä»¶å‡ºç°..."
          for i in $(seq 1 30); do  # æœ€å¤šç­‰30ç§’
            STATUS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE")
            
            if ! echo "$STATUS_RESPONSE" | grep -q '"message":"Not Found"'; then
              echo "çŠ¶æ€æ–‡ä»¶å·²æ‰¾åˆ°"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "âŒ é”™è¯¯ï¼šçŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸Šä¼ å¯èƒ½å·²å–æ¶ˆ"
              exit 1
            fi
            
            echo "ç­‰å¾…çŠ¶æ€æ–‡ä»¶... ($i/30)"
            sleep 1
          done
          
          # 2. ç­‰å¾…æ‰€æœ‰åˆ†å—å®Œæˆ
          echo "ç­‰å¾…æ‰€æœ‰åˆ†å—ä¸Šä¼ å®Œæˆ..."
          ALL_COMPLETED=false
          TOTAL_CHUNKS=0
          FILE_EXT=""
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            # è¶…æ—¶æ£€æŸ¥
            if [ $ELAPSED -gt $MAX_WAIT ]; then
              echo "âŒ ç­‰å¾…è¶…æ—¶ï¼ˆ30åˆ†é’Ÿï¼‰ï¼Œå¯èƒ½è¿˜æœ‰åˆ†å—æœªå®Œæˆ"
              exit 1
            fi
            
            # è¯»å–çŠ¶æ€æ–‡ä»¶
            STATUS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE")
            
            if echo "$STATUS_RESPONSE" | grep -q '"message":"Not Found"'; then
              echo "âŒ é”™è¯¯ï¼šçŠ¶æ€æ–‡ä»¶åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¢«åˆ é™¤"
              exit 1
            fi
            
            STATUS_CONTENT=$(echo "$STATUS_RESPONSE" | jq -r '.content // empty' | base64 -d)
            if [ -z "$STATUS_CONTENT" ]; then
              echo "â³ çŠ¶æ€æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œç­‰å¾…5ç§’..."
              sleep 5
              continue
            fi
            
            # è·å–æ€»åˆ†å—æ•°å’Œæ‰©å±•å
            TOTAL_CHUNKS=$(echo "$STATUS_CONTENT" | jq -r '.totalChunks')
            FILE_EXT=$(echo "$STATUS_CONTENT" | jq -r '.extension')
            
            # æ£€æŸ¥æ‰€æœ‰åˆ†å—çŠ¶æ€
            ALL_COMPLETED=true
            INCOMPLETE_CHUNKS=0
            
            for i in $(seq 0 $((TOTAL_CHUNKS - 1))); do
              STATUS=$(echo "$STATUS_CONTENT" | jq -r ".chunks[\"$i\"] // \"pending\"")
              if [ "$STATUS" != "completed" ]; then
                ALL_COMPLETED=false
                INCOMPLETE_CHUNKS=$((INCOMPLETE_CHUNKS + 1))
              fi
            done
            
            if [ "$ALL_COMPLETED" = "true" ]; then
              echo "âœ… æ‰€æœ‰åˆ†å—å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹åˆå¹¶"
              break
            else
              echo "â³ è¿˜æœ‰ $INCOMPLETE_CHUNKS/$TOTAL_CHUNKS ä¸ªåˆ†å—æœªå®Œæˆï¼Œå·²ç­‰å¾… ${ELAPSED}ç§’..."
              sleep 10  # ç­‰å¾…10ç§’åå†æ¬¡æ£€æŸ¥
            fi
          done
          
          echo "âœ… æ‰€æœ‰åˆ†å—å·²å®Œæˆï¼Œå¼€å§‹åˆå¹¶..."
          
          # 3. åˆ›å»ºä¸´æ—¶æ–‡ä»¶åˆå¹¶æ‰€æœ‰åˆ†å—
          TEMP_FILE="/tmp/merged_${FILE_ID}"
          rm -f "$TEMP_FILE"
          
          for i in $(seq 0 $((TOTAL_CHUNKS - 1))); do
            CHUNK_FILE="${{ env.TEMP_DIR }}/TEMPCHUNK_${FILE_ID}_${i}.dat"
            echo "ä¸‹è½½åˆ†å— $i..."
            
            CHUNK_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/$CHUNK_FILE")
            
            CHUNK_CONTENT=$(echo "$CHUNK_RESPONSE" | jq -r '.content // empty')
            if [ -z "$CHUNK_CONTENT" ]; then
              echo "âŒ é”™è¯¯ï¼šåˆ†å— $i æ•°æ®ç¼ºå¤±"
              exit 1
            fi
            
            echo "$CHUNK_CONTENT" | base64 -d >> "$TEMP_FILE"
            echo "åˆ†å— $i åˆå¹¶å®Œæˆ"
          done
          
          # 4. å‡†å¤‡ä¸Šä¼ æ•°æ®åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆé¿å…å‘½ä»¤è¡Œå‚æ•°è¿‡é•¿ï¼‰
          FINAL_FILENAME="${FILE_ID}${FILE_EXT}"
          FINAL_PATH="${{ env.UPLOAD_DIR }}/${FINAL_FILENAME}"
          
          echo "æ­£åœ¨ç¼–ç æ–‡ä»¶ä¸ºBase64..."
          MERGED_BASE64=$(base64 -w 0 "$TEMP_FILE")
          
          # åˆ›å»ºJSONæ•°æ®æ–‡ä»¶
          JSON_DATA=$(jq -n \
            --arg msg "ä¸Šä¼ åˆå¹¶æ–‡ä»¶: $FINAL_FILENAME" \
            --arg content "$MERGED_BASE64" \
            --arg branch "main" \
            '{message: $msg, content: $content, branch: $branch}')
          
          # å°†JSONæ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶
          JSON_FILE="/tmp/upload_${FILE_ID}.json"
          echo "$JSON_DATA" > "$JSON_FILE"
          
          echo "ä¸Šä¼ æœ€ç»ˆæ–‡ä»¶: $FINAL_FILENAME"
          echo "æ–‡ä»¶å¤§å°: $(stat -c%s "$TEMP_FILE") å­—èŠ‚"
          echo "Base64åå¤§å°: $(echo -n "$MERGED_BASE64" | wc -c) å­—ç¬¦"
          
          # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ä¸Šä¼ ï¼Œé¿å…å‘½ä»¤è¡Œå‚æ•°è¿‡é•¿
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            --data-binary @"$JSON_FILE" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/$FINAL_PATH"
          
          # æ¸…ç†ä¸´æ—¶JSONæ–‡ä»¶
          rm -f "$JSON_FILE"
          
          # 5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          
          # æ¸…ç†åˆ†å—æ•°æ®æ–‡ä»¶
          for i in $(seq 0 $((TOTAL_CHUNKS - 1))); do
            CHUNK_FILE="${{ env.TEMP_DIR }}/TEMPCHUNK_${FILE_ID}_${i}.dat"
            CHUNK_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/$CHUNK_FILE")
            
            if ! echo "$CHUNK_RESPONSE" | grep -q '"message":"Not Found"'; then
              CHUNK_SHA=$(echo "$CHUNK_RESPONSE" | jq -r '.sha // empty')
              if [ -n "$CHUNK_SHA" ] && [ "$CHUNK_SHA" != "null" ]; then
                curl -X DELETE -s \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  -d "{\"message\":\"æ¸…ç†åˆ†å— $i\",\"sha\":\"$CHUNK_SHA\",\"branch\":\"main\"}" \
                  "https://api.github.com/repos/${{ env.REPO }}/contents/$CHUNK_FILE"
                echo "æ¸…ç†åˆ†å— $i æ–‡ä»¶"
              fi
            fi
          done
          
          # æ¸…ç†çŠ¶æ€æ–‡ä»¶
          STATUS_SHA=$(echo "$STATUS_RESPONSE" | jq -r '.sha // empty')
          if [ -n "$STATUS_SHA" ] && [ "$STATUS_SHA" != "null" ]; then
            curl -X DELETE -s \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -d "{\"message\":\"æ¸…ç†çŠ¶æ€æ–‡ä»¶\",\"sha\":\"$STATUS_SHA\",\"branch\":\"main\"}" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/$STATUS_FILE"
            echo "æ¸…ç†çŠ¶æ€æ–‡ä»¶"
          fi
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼"
          echo "ğŸ“ æ–‡ä»¶å: $FINAL_FILENAME"
          echo "ğŸ“ è·¯å¾„: $FINAL_PATH"
          echo "ğŸ”— Raw URL: https://raw.githubusercontent.com/${{ env.REPO }}/main/$FINAL_PATH"
          echo "ğŸŒ CDN URL: https://cdn.jsdelivr.net/gh/${{ env.REPO }}/$FINAL_PATH"
          
      # ==================== æ¸…ç†è¿‡æœŸæ–‡ä»¶ ====================
      - name: æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶
        if: env.OPERATION == 'cleanup'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶ ==="
          
          CURRENT_TIME=$(date +%s)
          MAX_AGE=3600  # 1å°æ—¶
          
          # è·å– temp_uploads ç›®å½•å†…å®¹
          TEMP_DIR_CONTENT=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.TEMP_DIR }}")
          
          # æ¸…ç†çŠ¶æ€æ–‡ä»¶
          echo "æ£€æŸ¥çŠ¶æ€æ–‡ä»¶..."
          echo "$TEMP_DIR_CONTENT" | jq -r '.[] | select(.name | startswith("TEMPMETA_")) | .name' | while read -r FILE; do
            echo "æ£€æŸ¥æ–‡ä»¶: $FILE"
            
            FILE_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.TEMP_DIR }}/$FILE")
            
            FILE_CONTENT=$(echo "$FILE_RESPONSE" | jq -r '.content // empty' | base64 -d)
            if [ -n "$FILE_CONTENT" ]; then
              START_TIME=$(echo "$FILE_CONTENT" | jq -r '.startTime // 0')
              AGE=$((CURRENT_TIME - START_TIME))
              
              if [ $AGE -gt $MAX_AGE ]; then
                echo "æ¸…ç†è¿‡æœŸçŠ¶æ€æ–‡ä»¶: $FILE (åˆ›å»ºäº ${AGE}ç§’å‰)"
                FILE_SHA=$(echo "$FILE_RESPONSE" | jq -r '.sha // empty')
                
                if [ -n "$FILE_SHA" ] && [ "$FILE_SHA" != "null" ]; then
                  curl -X DELETE -s \
                    -H "Authorization: token $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    -d "{\"message\":\"æ¸…ç†è¿‡æœŸçŠ¶æ€æ–‡ä»¶\",\"sha\":\"$FILE_SHA\",\"branch\":\"main\"}" \
                    "https://api.github.com/repos/${{ env.REPO }}/contents/${{ env.TEMP_DIR }}/$FILE"
                  
                  # æå–æ–‡ä»¶ID
                  FILE_ID=$(echo "$FILE" | sed 's/TEMPMETA_//' | sed 's/.json//')
                  
                  # æ¸…ç†å¯¹åº”çš„åˆ†å—æ–‡ä»¶
                  echo "æ¸…ç†æ–‡ä»¶ID $FILE_ID çš„åˆ†å—æ–‡ä»¶..."
                  for i in $(seq 0 99); do  # å‡è®¾æœ€å¤š100ä¸ªåˆ†å—
                    CHUNK_FILE="${{ env.TEMP_DIR }}/TEMPCHUNK_${FILE_ID}_${i}.dat"
                    CHUNK_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                      "https://api.github.com/repos/${{ env.REPO }}/contents/$CHUNK_FILE")
                    
                    if ! echo "$CHUNK_RESPONSE" | grep -q '"message":"Not Found"'; then
                      CHUNK_SHA=$(echo "$CHUNK_RESPONSE" | jq -r '.sha // empty')
                      if [ -n "$CHUNK_SHA" ] && [ "$CHUNK_SHA" != "null" ]; then
                        curl -X DELETE -s \
                          -H "Authorization: token $GITHUB_TOKEN" \
                          -H "Accept: application/vnd.github+json" \
                          -d "{\"message\":\"æ¸…ç†è¿‡æœŸåˆ†å—\",\"sha\":\"$CHUNK_SHA\",\"branch\":\"main\"}" \
                          "https://api.github.com/repos/${{ env.REPO }}/contents/$CHUNK_FILE"
                      fi
                    fi
                  done
                fi
              else
                echo "ä¿ç•™çŠ¶æ€æ–‡ä»¶: $FILE (åˆ›å»ºäº ${AGE}ç§’å‰)"
              fi
            fi
          done
          
          echo "âœ… è¿‡æœŸæ–‡ä»¶æ¸…ç†å®Œæˆ"
