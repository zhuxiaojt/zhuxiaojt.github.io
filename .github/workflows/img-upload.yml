name: å›¾åºŠä¸Šä¼ API
on:
  repository_dispatch:
    types: [auto-upload-event]

jobs:
  upload-with-auto-number:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ ¸å¿ƒé…ç½®
        id: config
        run: |
          echo "UPLOAD_FOLDER=img" >> $GITHUB_ENV
          # ======================================================
          echo "BRANCH=main" >> $GITHUB_ENV
          echo "OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
          echo "REPO=${{ github.event.repository.name }}" >> $GITHUB_ENV
          echo "COUNTER_FILE=api/img/cnt.txt" >> $GITHUB_ENV

      - name: è¯»å–ã€api/img/cnt.txtã€‘çš„å½“å‰åºå·
        id: read-counter
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è¯»å–æ–°è·¯å¾„çš„è®¡æ•°æ–‡ä»¶
          COUNTER_CONTENT=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ env.OWNER }}/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}" | jq -r '.content')
          # Base64è§£ç è®¡æ•°æ–‡ä»¶å†…å®¹
          CURRENT_NUM=$(echo $COUNTER_CONTENT | base64 -d | tr -d '[:space:]')
          # è®¡æ•°è‡ªå¢
          NEW_NUM=$((CURRENT_NUM + 1))
          echo "å½“å‰è®¡æ•°ï¼š$CURRENT_NUM â†’ æ–°æ–‡ä»¶ç¼–å·ï¼š$NEW_NUM"
          echo "CURRENT_NUM=$CURRENT_NUM" >> $GITHUB_ENV
          echo "NEW_NUM=$NEW_NUM" >> $GITHUB_ENV

      - name: æå–æ–‡ä»¶åç¼€ + ç”Ÿæˆã€æ•°å­—+åç¼€ã€‘æœ€ç»ˆæ–‡ä»¶å
        id: gen-filename
        run: |
          ORIGIN_NAME="${{ github.event.client_payload.fileName }}"
          FILE_EXT=".${ORIGIN_NAME##*.}"
          FINAL_FILENAME="${{ env.NEW_NUM }}${FILE_EXT}"
          UPLOAD_PATH="${{ env.UPLOAD_FOLDER }}/${FINAL_FILENAME}"
          echo "åŸå§‹æ–‡ä»¶åï¼š$ORIGIN_NAME â†’ æœ€ç»ˆæ–‡ä»¶åï¼š$FINAL_FILENAME"
          echo "FINAL_FILENAME=$FINAL_FILENAME" >> $GITHUB_ENV
          echo "UPLOAD_PATH=$UPLOAD_PATH" >> $GITHUB_ENV

      - name: ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ï¼ˆä»…ä¸Šä¼ ï¼Œæ— åˆ é™¤åŠŸèƒ½ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE64_CONTENT: ${{ github.event.client_payload.base64Content }}
        run: |
          JSON_DATA=$(jq -n \
            --arg msg "è‡ªåŠ¨ç¼–å·ä¸Šä¼ : ${{ env.UPLOAD_PATH }}" \
            --arg content "$BASE64_CONTENT" \
            --arg branch "${{ env.BRANCH }}" \
            '{message: $msg, content: $content, branch: $branch}')
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$JSON_DATA" \
            "https://api.github.com/repos/${{ env.OWNER }}/${{ env.REPO }}/contents/${{ env.UPLOAD_PATH }}"

      - name: å†™å›è‡ªå¢åçš„åºå·åˆ°ã€api/img/cnt.txtã€‘ï¼ˆå®Œæˆé—­ç¯ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ä¿®æ”¹ï¼šè·å–æ–°è·¯å¾„è®¡æ•°æ–‡ä»¶çš„SHAå€¼ï¼ˆæ›´æ–°æ–‡ä»¶å¿…é¡»ä¼ SHAï¼‰
          COUNTER_SHA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ env.OWNER }}/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}" | jq -r '.sha')
          # å°†æ–°æ•°å­—è½¬ä¸ºBase64ç¼–ç ï¼ˆGitHub APIå¼ºåˆ¶è¦æ±‚ï¼‰
          NEW_NUM_BASE64=$(echo -n "${{ env.NEW_NUM }}" | base64)
          # æ›´æ–°æ–°è·¯å¾„çš„è®¡æ•°æ–‡ä»¶
          JSON_DATA=$(jq -n \
            --arg msg "è®¡æ•°è‡ªå¢: ${{ env.CURRENT_NUM }} â†’ ${{ env.NEW_NUM }}" \
            --arg content "$NEW_NUM_BASE64" \
            --arg sha "$COUNTER_SHA" \
            --arg branch "${{ env.BRANCH }}" \
            '{message: $msg, content: $content, sha: $sha, branch: $branch}')
          curl -X PUT -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$JSON_DATA" \
            "https://api.github.com/repos/${{ env.OWNER }}/${{ env.REPO }}/contents/${{ env.COUNTER_FILE }}"

      - name: ä¸Šä¼ å®Œæˆ
        run: |
          echo "ğŸ‰ ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶è·¯å¾„ï¼š${{ env.UPLOAD_PATH }}"
          echo "ğŸ‰ è®¡æ•°æ–‡ä»¶å·²æ›´æ–°ï¼šapi/img/cnt.txt â†’ ${{ env.NEW_NUM }}"
