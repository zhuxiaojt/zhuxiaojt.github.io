<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾åºŠä¸Šä¼ </title>
    <style>
        body {padding: 40px; font-family: sans-serif; max-width: 800px; margin: 0 auto;}
        #fileInput {padding: 10px; border:1px solid #ddd; border-radius:5px; width: 60%;}
        #uploadBtn {padding:10px 20px; background:#2ea44f; color:#fff; border:none; border-radius:5px; cursor:pointer; margin-left:10px;}
        #uploadBtn:disabled {background:#94d3a2; cursor:not-allowed;}
        #msg {margin-top:20px; font-size:14px; line-height:1.8; padding:10px; border-radius:5px;}
        .success {color:#155724; background:#d4edda; border:1px solid #c3e6cb; font-weight: bold;}
        .error {color:#721c24; background:#f8d7da; border:1px solid #f5c6cb;}
        .loading {color:#0c5460; background:#d1ecf1; border:1px solid #bee5eb;}
        #result {margin-top:15px; font-size:16px; color:#0066cc; font-weight: bold;}
    </style>
</head>
<body>
    <input type="file" id="fileInput" accept="*" />
    <button id="uploadBtn" disabled>é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </button>
    <div id="msg"></div>
    <div id="result"></div> <!-- ç”¨äºæ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶å -->

    <script>
        // ================ ä»“åº“ä¿¡æ¯ ================
        const GITHUB_USER = "zhuxiaojt";  // ä¾‹ï¼šabc123
        const GITHUB_REPO = "zhuxiaojt.github.io";  // ä¾‹ï¼šmy-img-bed
        const BASE64_TOKEN = "aHViX3BhdF8xMUJMT0tER1kwdTRMT2RKbXJhVzZFX0NTa3RvZ1pMYTV5d211RWdBRkxBVWVlcVpSRlBDZTlxZmpJeWgxakxGbTc1RVRYTVpHV2xmaThGM3Zu";
        const GITHUB_TOKEN = atob("Z2l0"+BASE64_TOKEN).trim();
        // ==============================================================
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const msg = document.getElementById('msg');
        const result = document.getElementById('result');
        const TRIGGER_API = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/dispatches`;
        const COUNTER_FILE_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/api/img/cnt.txt`; // è®¡æ•°æ–‡ä»¶ç›´è¯»åœ°å€ï¼ˆæ— ç¼“å­˜ï¼‰
        const MAX_SIZE = 25 * 1024 * 1024; // GitHubç¡¬æ€§é™åˆ¶ï¼šå•æ–‡ä»¶â‰¤25MB

        // é€‰æ‹©æ–‡ä»¶åå¯ç”¨æŒ‰é’®
        fileInput.addEventListener('change', () => {
            uploadBtn.disabled = !fileInput.files.length;
            msg.innerHTML = '';
            result.innerHTML = '';
            msg.className = '';
        });

        // ç‚¹å‡»ä¸Šä¼  - æ ¸å¿ƒé€»è¾‘
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            if (!file) return;
            if (file.size > MAX_SIZE) {
                msg.innerHTML = `âŒ æ–‡ä»¶è¿‡å¤§ï¼æœ€å¤§æ”¯æŒ25MBï¼Œå½“å‰ï¼š${(file.size/1024/1024).toFixed(2)}MB`;
                msg.className = 'error';
                return;
            }

            uploadBtn.disabled = true;
            msg.innerHTML = `ğŸ”„ æ­£åœ¨ä¸Šä¼ ã€${file.name}ã€‘ï¼Œè¯·ç¨å€™...`;
            msg.className = 'loading';
            result.innerHTML = '';

            try {
                // æ­¥éª¤1ï¼šæ–‡ä»¶è½¬çº¯Base64ç¼–ç ï¼ˆå»æ‰å‰ç¼€ï¼Œç¬¦åˆActionè¦æ±‚ï¼‰
                const pureBase64 = await fileToBase64(file);
                // æ­¥éª¤2ï¼šè°ƒç”¨APIè§¦å‘GitHub Actionä¸Šä¼ 
                await triggerUploadAction(file.name, pureBase64);
                // æ­¥éª¤3ï¼šä¸Šä¼ æˆåŠŸåï¼Œè¯»å–æœ€æ–°ç¼–å· + æ‹¼æ¥æœ€ç»ˆæ–‡ä»¶åã€æ ¸å¿ƒæ–°å¢ã€‘
                const latestNum = await readLatestFileNumber(); // è¯»å–æœ€æ–°ç¼–å·
                const fileExt = '.' + file.name.split('.').pop(); // æå–åŸæ–‡ä»¶åç¼€
                const finalFileName = `${latestNum}${fileExt}`; // æ‹¼æ¥ï¼šç¼–å·.åç¼€
                
                // é¡µé¢å±•ç¤ºç»“æœ
                msg.innerHTML = `âœ… ä¸Šä¼ æˆåŠŸï¼`;
                msg.className = 'success';
                result.innerHTML = `ğŸ“Œ ä¸Šä¼ åçš„æ–‡ä»¶åï¼š${finalFileName}`; // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            } catch (err) {
                msg.innerHTML = `âŒ ä¸Šä¼ å¤±è´¥ï¼š${err.message}`;
                msg.className = 'error';
                result.innerHTML = '';
            } finally {
                uploadBtn.disabled = false;
                fileInput.value = '';
            }
        });

        // âœ… å·¥å…·å‡½æ•°1ï¼šæœ¬åœ°æ–‡ä»¶ è½¬ çº¯Base64ç¼–ç ï¼ˆæ— å‰ç¼€ï¼‰
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                reader.onerror = (err) => reject(err);
                reader.readAsDataURL(file);
            });
        }

        // âœ… æ ¸å¿ƒå‡½æ•°ï¼šè§¦å‘GitHub Actionä¸Šä¼ çš„è¯·æ±‚
        async function triggerUploadAction(fileName, base64Content) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', TRIGGER_API, true);
                xhr.setRequestHeader('Accept', 'application/vnd.github+json');
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Authorization', `token ${GITHUB_TOKEN}`);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                
                xhr.onload = () => {
                    xhr.status === 204 ? resolve() : reject(new Error(xhr.responseText || xhr.statusText));
                };
                xhr.onerror = () => reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥'));
                
                xhr.send(JSON.stringify({
                    event_type: 'auto-upload-event',
                    client_payload: { operType: 'upload', fileName, base64Content }
                }));
            });
        }

        // âœ… æ ¸å¿ƒæ–°å¢å‡½æ•°ï¼šè¯»å–æœ€æ–°çš„æ–‡ä»¶ç¼–å·ï¼ˆä»api/img/cnt.txtè¯»å–ï¼‰
        async function readLatestFileNumber() {
            // åŠ éšæœºå‚æ•°é˜²ç¼“å­˜ï¼Œä¿è¯è¯»å–çš„æ˜¯æœ€æ–°å€¼
            const res = await fetch(`${COUNTER_FILE_URL}?t=${Date.now()}`);
            if (!res.ok) throw new Error('è¯»å–ç¼–å·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            const num = await res.text();
            return num.trim(); // è¿”å›çº¯æ•°å­—ç¼–å·
        }
    </script>
</body>
</html>
